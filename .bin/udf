#!/bin/bash

# Update Dot Files
# Pull and push changes to my dotfiles

IFS=$'\n'

cd "$HOME"
source "$HOME/.bash_colors"
source "$HOME/.bash_excuses"

OS=$(uname -s)

<<<<<<< HEAD
# TODO: Parse shortopts later but for now
#   adding "b" backs up Brewfiles on macOS
#   adding "d" backs up platform dependencies on all OSes
EXTRA_BACKUP_OPTION=$1
=======
# TODO: Parse shortopts later but for now adding any argument backups up the
# Brewfile on macOS. I add `udf -b` to fake it till I make it.
BACKUP_BREWFILE=$1
>>>>>>> a545dfa3e55a1a50d5568bba6b4f7c3bc10ce2ea

if [[ "$EXTRA_BACKUP_OPTION" == "b" && "$OS" == "Darwin" ]]; then
    echo "${CYAN}‚úîÔ∏é  Backing up Brewfile${STOP}"
    brew bundle dump --file=~/.Brewfile --force
fi

if [[ "$EXTRA_BACKUP_OPTION" == "d" ]]; then
    echo "${CYAN}‚úîÔ∏é  Backing up dependencies${STOP}"
fi

echo "${CYAN}‚úîÔ∏é  Attempting pull from Github${STOP}"
yadm pull origin master --quiet

echo "${CYAN}‚úîÔ∏é  Collecting any changed or deleted files${STOP}"
FILES=($(yadm status -uno --porcelain | cut -c4- | sed s/\"//g))
if [[ "${#FILES[@]}" -eq 0 ]]; then
    echo "${GREEN}ü§∑‚Äç‚ôÄÔ∏è Looks like nothing's changed${STOP}"
    exit 1
fi

for FILE in "${FILES[@]}"; do
    echo "${GREEN}+  Adding $HOME/$FILE${STOP}"
    yadm add "$HOME/$FILE"
done

echo "${CYAN}‚úîÔ∏é  Committing${STOP}"
yadm commit --quiet --message "$(random_excuse)"

echo "${CYAN}‚úîÔ∏é  Attempting push to Github${STOP}"
yadm push origin master --quiet

